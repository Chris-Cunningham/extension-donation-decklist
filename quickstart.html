<!DOCTYPE html>
<html>
  <head>
    <title>Donation Decklist</title>
    <meta charset='utf-8' />
  </head>
  <body>
    <table id="content-table">
        <tbody>
        <tr>
            <th>Deck</th>
            <th>Democracy Points</th>
            <th>Link</th>
        </tr>
        </tbody>
    </table>

    <script type="text/javascript">

      // Tell me how to use the spreadsheet.
      CELL_TYPES = ['TextOrLink', 'Votes', 'TextOrLink'];  // Supported cell types are TextOrLink, Votes.
                                                           // TextOrLink converts a URL into a formatted a element.
      CELL_CONTENTS = [ [3, 1], [0], [2] ];         // Array of arrays of indices.

      // Client ID and API key from the Developer Console
      var CLIENT_ID = '113528389247-uaj21g751tq0osm83k9hc2do2ab3f0r1.apps.googleusercontent.com';
      var API_KEY = 'AIzaSyAgTnnhamUN5hkryKuc9N5qNlyZHer3VJ4';
      // Array of API discovery doc URLs for APIs used by the quickstart
      var DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];
      // Authorization scopes required by the API; multiple scopes can be
      // included, separated by spaces.
      var SCOPES = "https://www.googleapis.com/auth/spreadsheets.readonly";

      /**
       *  On load, called to load the API client library.
       */
      function handleClientLoad() {
        gapi.load('client', initClient);
      }

      /**
       *  Initializes the API client library.
       */
      function initClient() {
        gapi.client.init({
          apiKey: API_KEY,
          client_id: CLIENT_ID,
          scope: SCOPES,
          discoveryDocs: DISCOVERY_DOCS
        }).then(function(response) {
          console.log('GAPI client loaded. Now accessing donation decklist.');
          listDecks();
        }, function(reason) {
          console.log('Extension Donation Decklist Error 1: ' + reason.result.error.message);
        });
      }

      /**
       * Append a row element to the table displaying the results of the API call.
       * Uses the parameters CELL_TYPES, CELL_CONTENTS to build the row.
       *
       * @param {row} a row from a Google Sheets API spreadsheet read.
       */
      function appendTable(row) {
        // Make a row in the table to put things in.
        var tbl = document.getElementById('content-table'),
            r = tbl.insertRow(tbl.rows.length),
            i;
        for (i=0; i < CELL_TYPES.length; i++) {
          if (CELL_TYPES[i] == 'TextOrLink') {
            cellcontents = ''
            for (j=0; j < CELL_CONTENTS[i].length; j++) {
              if (j > 0) cellcontents += ' ';
              cellcontents += row[CELL_CONTENTS[i][j]];
            }
          } else if (CELL_TYPES[i] == 'Votes') {
              cellcontents = row[CELL_CONTENTS[i][0]] + ' and a button!'; //TODO -- set this up so it can actually cause a button to be created.
          }
          createCell(r.insertCell(i), cellcontents, 'currently unused');

        }

      }

      // create DIV element and append to the table cell
      function createCell(cell, text, style) {

        var div = document.createElement('div') // create DIV element
        // div.setAttribute('class', style);   // set DIV class attribute. This could be useful soon.

        // See https://stackoverflow.com/questions/5717093/check-if-a-javascript-string-is-a-url
        // This tries to tell if a string is a URL by asking the browser to parse
        // it as a URL. If the result goes to a different host, the string is probably a URL.
        var a  = document.createElement('a');
        a.href = text;
        if (a.host && a.host != window.location.host) {
          a.text = 'Decklist at '+a.host
          a.target = '_blank'
          div.appendChild(a);    // The anchor element here is valid, so use it.
        } else {
          var txt = document.createTextNode(text); // create text node
          div.appendChild(txt);                    // append text node to the DIV
        }

        cell.appendChild(div);                   // append DIV to the table cell
      }

      /**
       * Print the decklists from a specific spreadsheet:
       * https://docs.google.com/spreadsheets/d/1DuDRgdV0LNJC2YNMJS4K24tds2e-L6F9cZuaSjTC0-0
       */
      function listDecks() {
        gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: '1DuDRgdV0LNJC2YNMJS4K24tds2e-L6F9cZuaSjTC0-0',
          range: 'Magic!A2:F',
        }).then(function(response) {
          var range = response.result;
          if (range.values.length > 0) {
            for (i = 0; i < range.values.length; i++) {
              var row = range.values[i];
              if (String(row[1]) != 'undefined') {   // Don't display blank rows.
                // Print columns D, B, A, and C, which correspond to indices 3, 1, 0, 2.
                appendTable(row);
              }
            }
          } else {
            appendTable(['No data found.']);
          }
        }, function(response) {
          appendTable(['Extension Donation Decklist Error 2: ' + response.result.error.message]);
        });
      }

    </script>

    <script async defer src="https://apis.google.com/js/api.js"
      onload="this.onload=function(){};handleClientLoad()"
      onreadystatechange="if (this.readyState === 'complete') this.onload()">
    </script>

  </body>
</html>