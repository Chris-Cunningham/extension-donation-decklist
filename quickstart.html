<!DOCTYPE html>
<html>
  <head>
    <title>Donation Decklist</title>
    <meta charset='utf-8' />
  </head>
  <body>
    <table id="content-table">
        <tbody>
        <tr>
            <th>Deck</th>
            <th>Democracy Points</th>
            <th>Link</th>
        </tr>
        </tbody>
    </table>

    <script type="text/javascript">

      // Tell me how to use the spreadsheet.
      CELL_TYPES = ['TextOrLink', 'Votes', 'TextOrLink'];  // Supported cell types are TextOrLink, Votes.
                                                           // TextOrLink converts a URL into a formatted a element.
      CELL_CONTENTS = [ [3, 1], [0, 4], [2] ];             // Array of arrays of indices.
      USE_AS_KEY = [3, 1, 2];                              // Which columns should be concatenated together to identify a deck?

      // See https://jsperf.com/string-hashing-methods
      // Referenced from https://stackoverflow.com/questions/7616461/generate-a-hash-from-string-in-javascript-jquery
      function djb2Code(str) {
        var hash = 5381;
        for (var i = 0; i < str.length; i++) {
          char = str.charCodeAt(i);
          hash = ((hash << 5) + hash) + char; /* hash * 33 + c */
        }
        return hash;
      }
      // Identifier for a deck will come from some of its columns concatenated together.
      function hashOfDeck(row) {
        string_of_deck = '';
        // Concatenate the relevant columns together.
        for (var j = 0; j < USE_AS_KEY.length; j++) {
          string_of_deck += row[USE_AS_KEY[j]];
        };
        // Return a hash of the string that is created.
        return djb2Code(string_of_deck)
      }

      // Client ID and API key from the Developer Console
      var CLIENT_ID = '113528389247-uaj21g751tq0osm83k9hc2do2ab3f0r1.apps.googleusercontent.com';
      var API_KEY = 'AIzaSyAgTnnhamUN5hkryKuc9N5qNlyZHer3VJ4';
      // Array of API discovery doc URLs for APIs used by the quickstart
      var DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];
      // Authorization scopes required by the API; multiple scopes can be
      // included, separated by spaces.
      var SCOPES = "https://www.googleapis.com/auth/spreadsheets.readonly";

      /**
       *  On load, called to load the API client library.
       */
      function handleClientLoad() {
        gapi.load('client', initClient);
      }

      /**
       *  Initializes the API client library.
       */
      function initClient() {
        gapi.client.init({
          apiKey: API_KEY,
          client_id: CLIENT_ID,
          scope: SCOPES,
          discoveryDocs: DISCOVERY_DOCS
        }).then(function(response) {
          listDecks();
        }, function(reason) {

          console.log('Extension Donation Decklist Error 1: ' + reason.result.error.message);
        });
      }

      /**
       * Append a row element to the table displaying the results of the API call.
       * Uses the parameters CELL_TYPES, CELL_CONTENTS to build the row.
       *
       * @param {row} a row from a Google Sheets API spreadsheet read.
       */
      function appendTable(row) {
        // Make a row in the table to put things in.
        var tbl = document.getElementById('content-table'),
            r = tbl.insertRow(tbl.rows.length);
        for (var i=0; i < CELL_TYPES.length; i++) {
          if (CELL_TYPES[i] == 'TextOrLink') {
            cellcontents = ''
            for (var j=0; j < CELL_CONTENTS[i].length; j++) {
              if (j > 0) cellcontents += ' ';
              cellcontents += row[CELL_CONTENTS[i][j]];
              voteButtonText = null;
            }
          } else if (CELL_TYPES[i] == 'Votes') {
              // slot 0 is Total, slot 1 is $$, if there is a slot 2, it is democracy points from actual votes
              // The leftovers must be the number of days.
              cellcontents = ''
              totalvotes = row[CELL_CONTENTS[i][0]];
              moneyvotes = row[CELL_CONTENTS[i][1]];
              daysvotes = totalvotes - moneyvotes;
              if (CELL_CONTENTS[i].length >= 3) {
                votesvotes = row[CELL_CONTENTS[i][2]];
                cellcontents += '+'+votesvotes+'v';
                daysvotes -= votesvotes;
              }
              cellcontents = totalvotes + ' ($' + moneyvotes + '+' + daysvotes + 'd' + cellcontents + ')'
              voteButtonText = 'Vote for '+hashOfDeck(row);
          }

        createCell(r.insertCell(i), cellcontents, voteButtonText, '');

        }

      }

      // create DIV element and append to the table cell. If voteButtonText is not null, we will make a button!
      function createCell(cell, text, voteButtonText, style) {

        var div = document.createElement('div') // create DIV element
        // div.setAttribute('class', style);   // set DIV class attribute. This could be useful soon.

        // See https://stackoverflow.com/questions/5717093/check-if-a-javascript-string-is-a-url
        // This tries to tell if a string is a URL by asking the browser to parse
        // it as a URL. If the result goes to a different host, the string is probably a URL.
        var a  = document.createElement('a');
        a.href = text;
        if (a.host && a.host != window.location.host) {
          a.text = 'Decklist at '+a.host
          a.target = '_blank'
          div.appendChild(a);    // The anchor element here is valid, so use it.
        } else {
          var txt = document.createTextNode(text); // create text node
          div.appendChild(txt);                    // append text node to the DIV
          if (voteButtonText) {
            var btn = document.createElement("BUTTON");
            var t = document.createTextNode(voteButtonText);
            btn.appendChild(t);
            div.appendChild(btn);
          }
        }

        cell.appendChild(div);                   // append DIV to the table cell
      }

      /**
       * Print the decklists from a specific spreadsheet:
       * https://docs.google.com/spreadsheets/d/1DuDRgdV0LNJC2YNMJS4K24tds2e-L6F9cZuaSjTC0-0
       */
      function listDecks() {
        gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: '1DuDRgdV0LNJC2YNMJS4K24tds2e-L6F9cZuaSjTC0-0',
          range: 'Magic!A2:F',
        }).then(function(response) {
          var range = response.result;
          if (range.values.length > 0) {
            for (var i = 0; i < range.values.length; i++) {
              var row = range.values[i];
              if (String(row[1]) != 'undefined') {   // Don't display blank rows.
                appendTable(row);
              }
            }
          } else {
            console.log('No data found.');
          }
        }, function(response) {
          console.log('Extension Donation Decklist Error 2: ' + response.result.error.message);
        });
      }

    </script>

    <script async defer src="https://apis.google.com/js/api.js"
      onload="this.onload=function(){};handleClientLoad()"
      onreadystatechange="if (this.readyState === 'complete') this.onload()">
    </script>

  </body>
</html>